# SPDX-License-Identifier: LGPL-3.0-or-later
# Maintainer: Susant Sahani <susant@redhat.com>

pkgname=cloud-netconfig
pkgver=0.3.0
pkgrel=1
pkgdesc="Cloud instance network configuration daemon"
arch=('x86_64' 'aarch64')
url="https://github.com/ssahani/cloud-netconfig"
license=('LGPL3')
depends=('systemd')
makedepends=('cargo' 'rust')
backup=('etc/cloud-network/config.yaml')
source=("$pkgname-$pkgver.tar.gz::https://github.com/ssahani/$pkgname/archive/v$pkgver.tar.gz")
sha256sums=('SKIP')

build() {
    cd "$pkgname-$pkgver"
    cargo build --release --locked
}

check() {
    cd "$pkgname-$pkgver"
    cargo test --release --locked
}

package() {
    cd "$pkgname-$pkgver"

    # Binaries
    install -Dm755 target/release/cloud-netconfigd "$pkgdir/usr/bin/cloud-netconfigd"
    install -Dm755 target/release/cnctl "$pkgdir/usr/bin/cnctl"

    # Configuration
    install -Dm644 distribution/etc/cloud-network/config.yaml "$pkgdir/etc/cloud-network/config.yaml"

    # Examples
    install -d "$pkgdir/usr/share/doc/$pkgname/examples"
    install -m644 distribution/etc/cloud-network/examples/*.yaml "$pkgdir/usr/share/doc/$pkgname/examples/"

    # Systemd service
    install -Dm644 distribution/lib/systemd/system/cloud-netconfigd.service "$pkgdir/usr/lib/systemd/system/cloud-netconfigd.service"

    # Shell completions
    install -Dm644 distribution/usr/share/bash-completion/completions/cnctl "$pkgdir/usr/share/bash-completion/completions/cnctl"
    install -Dm644 distribution/usr/share/zsh/site-functions/_cnctl "$pkgdir/usr/share/zsh/site-functions/_cnctl"
    install -Dm644 distribution/usr/share/fish/vendor_completions.d/cnctl.fish "$pkgdir/usr/share/fish/vendor_completions.d/cnctl.fish"

    # Documentation
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 LICENSE.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
